<%rebase('base.html',title="Control Producción")
import utils
import datetime
from bottle import request, redirect

db = utils.ConnectDB()

id = request.GET.id
turno = request.GET.turno

if not id:
  redirect('principal.html')
end

if turno == '1':
    desde = id+"T06:00:00"
    hasta = id+"T14:00:00"
elif turno == '2':
    desde = id+"T14:00:00"
    hasta = id+"T22:00:00"
elif turno == '3':
    desde = id+"T22:00:00"
    id = (datetime.datetime.strptime(id, '%Y-%m-%d') + datetime.timedelta(days=1)).strftime("%Y-%m-%d")
    hasta = id+"T06:00:00"
end
       
%>
<h2 class="ui header">Edicion Turno:</h2>
<div class="ui buttons">
  <a class="ui button" href="/turnos/principal.html">Turnos</a>
  <a class="ui button" href="/main_menu.html">Menu Principal</a>
</div>
<form class="ui form">
    <div class="fields">
        <div class="eight wide field">
          <label>Desde</label>
          <input type="datetime-local" name="desde" value="{{desde}}">
        </div>
        <div class="eight wide field">
          <label>Hasta</label>
          <input type="datetime-local" name="hasta" value="{{hasta}}">
        </div>        
    </div>
    <div class="field">
        <label>Operario</label>
        <select class="ui search selection dropdown" id="operario" name="operario">
        </select>
    </div>


    <div class="ui buttons">
            <button class="ui button" type="submit" formaction="guardar.html" formmethod="POST">Registrar</button>   
    </div>
    <input type="hidden" name="fecha_turno" value="{{id}}">
    <input type="hidden" name="turno" value="{{turno}}">
</form>

<table class="ui table">
    <thead>
        <th>Fecha Turno</th>
        <th>Turno</th>
        <th>Empleado</th>
        <th>Desde</th>
        <th>Hasta</th>
        <th>Acci&oacute;n</th>
    </thead>
    <tbody>
        <% db.execute("SELECT a.`fecha_turno`, a.`turno`, a.`idtercero`, CONCAT(a.`idtercero`,' - ',b.nombre) as operario, `desde`, `hasta` FROM `registro_turnos` as a LEFT OUTER JOIN terceros as b ON a.idtercero = b.idtercero WHERE fecha_turno = %s and turno = %s",[id, turno])
           for row in db:
        %>
        <tr>
            <td>{{row['fecha_turno']}}</td>
            <td>{{row['turno']}}</td>
            <td>{{row['operario']}}</td>
            <td>{{row['desde']}}</td>
            <td>{{row['hasta']}}</td>
            <td>
                <div class="ui buttons">
                    <a class="ui vertical animated button" href="javascript: confirmar_borrado('{{row['fecha_turno']}}', '{{row['turno']}}','{{row['idtercero']}}')">
                      <div class="hidden content">Eliminar</div>
                      <div class="visible content">
                        <i class="remove icon"></i>
                      </div>
                    </a>
                    <a class="ui vertical animated button" href="javascript:modificar('{{row['desde']}}', '{{row['hasta']}}','{{row['idtercero']}}','{{row['operario']}}')">
                      <div class="hidden content">Editar</div>
                      <div class="visible content">
                        <i class="edit icon"></i>
                      </div>
                    </a>
                </div>
            </td>
        </tr>
        %end
    </tbody>
</table>

<script type="text/javascript">

    function confirmar_borrado(fecha_turno, turno, idtercero)
    {
        if (confirm("¿ Desea borrar este registro ?"))
        {
            document.location = 'eliminar.html?fecha_turno='+fecha_turno+'&turno='+turno+'&idtercero='+idtercero;
        }
    };

    function modificar(desde, hasta, idtercero,nombre_tercero)
    {
      $('input[name="desde"]').val(desde.replace(' ','T'))
      $('input[name="hasta"]').val(hasta.replace(' ','T'))
      $('#operario').val(idtercero)
      $('#operario').dropdown('set value',idtercero);
      $('#operario').dropdown('set text',nombre_tercero);
    };


  $('#operario').dropdown({
      apiSettings: {
        url: '/terceros/buscar.json?tipo=EMPL&query={query}'
      }
  });


</script>